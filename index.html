<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Técnica de Pneus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Animação suave para o Modal */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-20">

    <div id="modal-mes" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="bg-blue-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold">Novo Período</h3>
                <button onclick="ui.toggleModalMes(false)" class="hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Selecione o Período</label>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <select id="sel-mes" class="w-full border-2 rounded-xl p-2 font-bold bg-slate-50">
                        <option>Janeiro</option><option>Fevereiro</option><option>Março</option>
                        <option>Abril</option><option>Maio</option><option>Junho</option>
                        <option>Julho</option><option>Agosto</option><option>Setembro</option>
                        <option>Outubro</option><option>Novembro</option><option>Dezembro</option>
                    </select>
                    <select id="sel-ano" class="w-full border-2 rounded-xl p-2 font-bold bg-slate-50">
                        <option>2025</option><option>2026</option><option>2027</option><option>2028</option>
                    </select>
                </div>
                <button onclick="core.criarMes()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-colors">
                    CRIAR MÊS
                </button>
            </div>
        </div>
    </div>

    <div id="main-view" class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-blue-900 uppercase tracking-tighter">Avaliação de Pneus</h1>
            <button onclick="ui.toggleModalMes(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition-transform hover:scale-105">
                + INICIAR MÊS
            </button>
        </div>
        <div id="cards-meses" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>
    </div>

    <div id="mes-view" class="container mx-auto p-4 hidden">
        <button onclick="ui.backToMain()" class="text-blue-600 font-bold mb-4 flex items-center gap-2 hover:underline">
            <i class="fas fa-arrow-left"></i> Voltar ao Painel
        </button>
        
        <div id="cabecalho-mes" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border-l-8 border-blue-500">
            </div>

        <div id="cards-avaliacoes" class="space-y-3">
            </div>

        <div class="fixed bottom-6 right-6 flex gap-2 z-40">
            <button onclick="ui.openForm()" class="bg-green-600 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform font-bold flex items-center gap-2">
                <i class="fas fa-plus"></i> NOVO PNEU
            </button>
        </div>
    </div>

    <div id="form-view" class="container mx-auto p-4 hidden">
        <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="bg-blue-900 text-white p-6 flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold">Ficha Técnica</h2>
                    <p id="form-seq-info" class="text-blue-200 text-sm italic"></p>
                </div>
                <button onclick="ui.backToMes()" class="text-blue-200 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-8">
                <section>
                    <h3 class="text-blue-900 font-black border-b-2 border-blue-100 mb-4 uppercase text-sm">1. Planejamento e Instruções</h3>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Como será realizado</label>
                    <textarea id="f_como" class="w-full border-2 rounded-xl p-3 mt-1 focus:border-blue-500 outline-none h-24" placeholder="Descreva o procedimento..."></textarea>
                    
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Início</label><input type="datetime-local" id="f_data_ini" class="w-full border-2 rounded-xl p-2"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Fim</label><input type="datetime-local" id="f_data_fim" class="w-full border-2 rounded-xl p-2"></div>
                    </div>
                </section>

                <section class="bg-gray-50 p-4 rounded-2xl">
                    <h3 class="text-blue-900 font-black mb-4 uppercase text-sm">2. Localização</h3>
                    <input type="text" id="f_nome_local" placeholder="Nome do Local" class="w-full border-2 rounded-xl p-2 mb-2">
                    <input type="text" id="f_razao" placeholder="Razão Social" class="w-full border-2 rounded-xl p-2 mb-2">
                    <input type="text" id="f_endereco" placeholder="Endereço Completo" class="w-full border-2 rounded-xl p-2">
                </section>

                <section>
                    <h3 class="text-blue-900 font-black mb-2 uppercase text-sm">3. Responsáveis</h3>
                    <div class="flex gap-4 overflow-x-auto pb-2" id="responsaveis-list"></div>
                </section>

                <section class="border-2 border-orange-100 p-4 rounded-2xl">
                    <h3 class="text-orange-600 font-black mb-4 uppercase text-sm">4. Dados Técnicos</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="f_marca" class="border-2 rounded-xl p-2"><option>Goodyear</option><option>Continental</option><option>Pirelli</option><option>Michelin</option><option>Outros</option></select>
                        <select id="f_medida" class="border-2 rounded-xl p-2"><option>395/65R22.5</option><option>295/80R</option><option>275/80R</option><option>Outros</option></select>
                        <select id="f_desenho" class="border-2 rounded-xl p-2"><option>Liso</option><option>Borrachudo</option><option>Misto</option></select>
                        <select id="f_profundidade" class="border-2 rounded-xl p-2"></select>
                    </div>
                    <div class="mt-3">
                        <label class="block text-xs font-bold text-gray-500">VIDA DO PNEU</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button onclick="ui.setVida('Novo')" class="vida-btn border-2 p-2 rounded-lg text-xs font-bold">NOVO</button>
                            <button onclick="ui.setVida('R1')" class="vida-btn border-2 p-2 rounded-lg text-xs font-bold">R1</button>
                            <button onclick="ui.setVida('R2')" class="vida-btn border-2 p-2 rounded-lg text-xs font-bold">R2</button>
                            <button onclick="ui.setVida('R3')" class="vida-btn border-2 p-2 rounded-lg text-xs font-bold">R3</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-blue-900 font-black mb-4 uppercase text-sm">5. Detalhes da Carcaça</h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <input type="text" id="f_dot" placeholder="DOT" class="border-2 rounded-xl p-2">
                        <input type="text" id="f_fogo" placeholder="Nº DE FOGO" class="border-2 rounded-xl p-2">
                    </div>
                    <select id="f_avaria" class="w-full border-2 rounded-xl p-2 mb-2"><option value="">Selecione a Avaria</option><option>Deslocamento de linner</option><option>Cortes no flanco</option><option>Estouro de carcaça</option></select>
                    <select id="f_causa" class="w-full border-2 rounded-xl p-2"><option value="">Causa Provável</option><option>Defeito da pista</option><option>Falta de rodízio</option></select>
                </section>

                <section>
                    <h3 class="text-blue-900 font-black mb-2 uppercase text-sm">6. Fotos</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <div class="aspect-square bg-gray-200 rounded-xl flex items-center justify-center"><i class="fas fa-camera text-gray-500"></i></div>
                    </div>
                </section>

                <div class="flex flex-col gap-3 pt-6">
                    <button onclick="core.salvarPreenchimento()" class="bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700">FINALIZAR E SALVAR</button>
                    <button onclick="ui.backToMes()" class="text-gray-500 font-bold p-3 hover:text-red-500">CANCELAR PREENCHIMENTO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR LÓGICO ---
        const core = {
            db: JSON.parse(localStorage.getItem('tire_app_v2')) || { meses: [] },
            idxAtivo: null,
            vidaSelecionada: 'Novo',

            save: () => localStorage.setItem('tire_app_v2', JSON.stringify(core.db)),

            // ATUALIZADO: Agora pega do Modal
            criarMes: () => {
                const mes = document.getElementById('sel-mes').value;
                const ano = document.getElementById('sel-ano').value;
                const nomeCompleto = `${mes} ${ano}`;

                core.db.meses.push({
                    id: Date.now(),
                    nome: nomeCompleto,
                    status: 'Em andamento',
                    avaliacoes: [],
                    config: { instrucoes: '', local: '', responsaveis: ['Responsável 1'] }
                });
                core.save();
                ui.toggleModalMes(false); // Fecha o modal
                ui.renderMain();
            },

            // NOVO: Função para excluir mês
            excluirMes: (idx) => {
                const mes = core.db.meses[idx];
                if(confirm(`ATENÇÃO: Deseja apagar o mês de ${mes.nome} e todas as suas avaliações?`)) {
                    core.db.meses.splice(idx, 1);
                    core.save();
                    ui.renderMain();
                }
            },

            salvarPreenchimento: () => {
                const mes = core.db.meses[core.idxAtivo];
                const novoPneu = {
                    seq: (mes.avaliacoes.length + 1).toString().padStart(5, '0'),
                    data: new Date().toLocaleString(),
                    marca: document.getElementById('f_marca').value,
                    medida: document.getElementById('f_medida').value,
                    desenho: document.getElementById('f_desenho').value,
                    profundidade: document.getElementById('f_profundidade').value,
                    vida: core.vidaSelecionada,
                    dot: document.getElementById('f_dot').value,
                    fogo: document.getElementById('f_fogo').value,
                    avaria: document.getElementById('f_avaria').value,
                    causa: document.getElementById('f_causa').value
                };
                mes.avaliacoes.push(novoPneu);
                core.save();
                ui.backToMes();
            },

            exportarCSV: (idx) => {
                const mes = core.db.meses[idx];
                let csv = "Sequencial;Data;Marca;Medida;Profundidade;Vida;Avaria;Causa\n";
                mes.avaliacoes.forEach(p => {
                    csv += `${p.seq};${p.data};${p.marca};${p.medida};${p.profundidade};${p.vida};${p.avaria};${p.causa}\n`;
                });
                const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Avaliacao_${mes.nome.replace(/\s/g, '_')}.csv`;
                link.click();
            }
        };

        // --- INTERFACE (UI) ---
        const ui = {
            // NOVO: Controle do Modal
            toggleModalMes: (show) => {
                const el = document.getElementById('modal-mes');
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },

            renderMain: () => {
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('mes-view').classList.add('hidden');
                document.getElementById('form-view').classList.add('hidden');
                
                const container = document.getElementById('cards-meses');
                // ATUALIZADO: Adicionado botão de lixeira no card
                container.innerHTML = core.db.meses.map((m, i) => `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow relative">
                        <button onclick="core.excluirMes(${i})" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>

                        <div class="flex justify-between items-start mb-4 pr-8">
                            <div>
                                <h3 class="font-black text-lg text-slate-700">${m.nome}</h3>
                                <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold uppercase">${m.status}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mb-4 font-medium"><i class="fas fa-layer-group mr-1"></i> ${m.avaliacoes.length} Pneus</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="ui.openMes(${i})" class="bg-blue-50 text-blue-600 p-2 rounded-xl font-bold text-sm hover:bg-blue-100">ABRIR</button>
                            <button onclick="core.exportarCSV(${i})" class="bg-green-50 text-green-600 p-2 rounded-xl font-bold text-sm text-center hover:bg-green-100">CSV</button>
                        </div>
                    </div>
                `).join('');
            },

            openMes: (idx) => {
                core.idxAtivo = idx;
                const m = core.db.meses[idx];
                document.getElementById('main-view').classList.add('hidden');
                document.getElementById('mes-view').classList.remove('hidden');
                
                document.getElementById('cabecalho-mes').innerHTML = `
                    <h2 class="text-2xl font-black text-blue-900">${m.nome}</h2>
                    <div class="flex gap-4 mt-2 text-sm font-bold text-slate-500">
                        <span><i class="fas fa-clipboard-list mr-1"></i> ${m.avaliacoes.length} AVALIAÇÕES</span>
                    </div>
                `;

                const list = document.getElementById('cards-avaliacoes');
                list.innerHTML = m.avaliacoes.map((p, i) => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-bold text-gray-400">#${p.seq}</span>
                            <h4 class="font-bold text-slate-700">${p.marca} - ${p.medida}</h4>
                            <p class="text-xs text-gray-500">${p.vida} | Prof: ${p.profundidade} | ${p.data}</p>
                        </div>
                        <i class="fas fa-check text-green-500"></i>
                    </div>
                `).join('');
            },

            openForm: () => {
                const mes = core.db.meses[core.idxAtivo];
                document.getElementById('mes-view').classList.add('hidden');
                document.getElementById('form-view').classList.remove('hidden');
                document.getElementById('form-seq-info').innerText = `Ref: ${mes.nome} | Seq nº ${mes.avaliacoes.length + 1}`;
                
                // Reset visual dos responsáveis
                const respList = document.getElementById('responsaveis-list');
                respList.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center border-2 border-blue-500 text-blue-600 font-bold">R1</div>
                    <div class="flex-shrink-0 w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center border-2 border-gray-300 text-gray-400 cursor-pointer hover:bg-gray-200">+</div>
                `;
            },

            backToMain: () => ui.renderMain(),
            backToMes: () => ui.openMes(core.idxAtivo),

            setVida: (v) => {
                core.vidaSelecionada = v;
                document.querySelectorAll('.vida-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
                event.target.classList.add('bg-blue-600', 'text-white');
            }
        };

        // Popular Profundidade
        const profSelect = document.getElementById('f_profundidade');
        for(let i=0; i<=16; i++) {
            profSelect.innerHTML += `<option value="${i}mm">${i} mm</option>`;
        }

        ui.renderMain();
    </script>
</body>
</html>